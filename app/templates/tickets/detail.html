{% extends "base.html" %}

{% block title %}Ticket #{{ ticket.id }} - {{ ticket.subject }} - Helpdesk System{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Ticket Header -->
    <div class="card mb-6">
        <div class="card-header flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold">
                    #{{ ticket.id }} - {{ ticket.subject }}
                </h1>
                <div class="flex items-center gap-3 mt-2">
                    <span class="badge badge-{{ 'success' if ticket.status == 'open' else 'warning' if ticket.status == 'in_progress' else 'info' if ticket.status == 'resolved' else 'error' }}">
                        {{ ticket.status.replace('_', ' ').title() }}
                    </span>
                    <span class="badge priority-{{ ticket.priority }}">
                        {{ ticket.priority.title() }} Priority
                    </span>
                    <span class="text-sm text-gray-600">Category: {{ ticket.category.name }}</span>
                </div>
            </div>
            
            <!-- Voting Section -->
            <div class="flex items-center gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold" id="vote-score-{{ ticket.id }}">
                        {{ ticket.vote_score }}
                    </div>
                    <div class="text-xs text-gray-500">votes</div>
                </div>
                
                <div class="flex flex-col gap-2">
                    <button class="btn btn-outline vote-btn" 
                            data-ticket-id="{{ ticket.id }}" 
                            data-is-upvote="true">
                        ↑ Upvote
                    </button>
                    <button class="btn btn-outline vote-btn" 
                            data-ticket-id="{{ ticket.id }}" 
                            data-is-upvote="false">
                        ↓ Downvote
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card-body">
            <div class="mb-4">
                <h3 class="font-semibold mb-2">Description:</h3>
                <div class="bg-gray-50 p-4 rounded">
                    {{ ticket.description | replace('\n', '<br>') | safe }}
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="font-medium">Created by:</span><br>
                    {{ ticket.owner.username }}
                </div>
                <div>
                    <span class="font-medium">Assigned to:</span><br>
                    {% if ticket.assignee %}
                        {{ ticket.assignee.username }}
                    {% else %}
                        Unassigned
                    {% endif %}
                </div>
                <div>
                    <span class="font-medium">Created:</span><br>
                    {{ ticket.created_at.strftime('%Y-%m-%d %H:%M') }}
                </div>
                <div>
                    <span class="font-medium">Last Updated:</span><br>
                    {{ ticket.updated_at.strftime('%Y-%m-%d %H:%M') }}
                </div>
            </div>
            
            <!-- Admin/Agent Controls -->
            {% if user.role in ['agent', 'admin'] %}
                <div class="mt-6 p-4 bg-blue-50 rounded">
                    <h3 class="font-semibold mb-3">Ticket Management:</h3>
                    <form method="POST" action="{{ url_for('tickets.update_ticket', ticket_id=ticket.id) }}" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Status:</label>
                            <select name="status" class="w-full status-select" 
                                    data-ticket-id="{{ ticket.id }}" 
                                    data-original-value="{{ ticket.status }}">
                                <option value="open" {% if ticket.status == 'open' %}selected{% endif %}>Open</option>
                                <option value="in_progress" {% if ticket.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                                <option value="resolved" {% if ticket.status == 'resolved' %}selected{% endif %}>Resolved</option>
                                <option value="closed" {% if ticket.status == 'closed' %}selected{% endif %}>Closed</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Assign to:</label>
                            <select name="assigned_to" class="w-full">
                                <option value="">Unassigned</option>
                                {% for agent in agents %}
                                    <option value="{{ agent.id }}" {% if ticket.assigned_to == agent.id %}selected{% endif %}>
                                        {{ agent.username }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Priority:</label>
                            <select name="priority" class="w-full">
                                <option value="low" {% if ticket.priority == 'low' %}selected{% endif %}>Low</option>
                                <option value="medium" {% if ticket.priority == 'medium' %}selected{% endif %}>Medium</option>
                                <option value="high" {% if ticket.priority == 'high' %}selected{% endif %}>High</option>
                                <option value="urgent" {% if ticket.priority == 'urgent' %}selected{% endif %}>Urgent</option>
                            </select>
                        </div>
                        
                        <div class="md:col-span-3">
                            <button type="submit" class="btn btn-primary">Update Ticket</button>
                        </div>
                    </form>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Attachments -->
    {% if attachments %}
        <div class="card mb-6">
            <div class="card-header">
                <h3 class="font-semibold">Attachments</h3>
            </div>
            <div class="card-body">
                <div class="space-y-2">
                    {% for attachment in attachments %}
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                            <div>
                                <span class="font-medium">{{ attachment.original_filename }}</span>
                                <span class="text-sm text-gray-500 ml-2">
                                    ({{ "%.1f"|format(attachment.file_size / 1024 / 1024) }} MB)
                                </span>
                            </div>
                            <div class="text-sm text-gray-500">
                                Uploaded by {{ attachment.uploader.username }} 
                                on {{ attachment.created_at.strftime('%Y-%m-%d %H:%M') }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
    
    <!-- Comments Section -->
    <div class="card">
        <div class="card-header">
            <h3 class="font-semibold">Comments ({{ comments|length }})</h3>
        </div>
        
        <div class="card-body">
            <!-- Add Comment Form -->
            <form method="POST" action="{{ url_for('comments.create_comment') }}" class="comment-form mb-6">
                <input type="hidden" name="ticket_id" value="{{ ticket.id }}">
                
                <div class="mb-4">
                    <label for="content" class="block text-sm font-medium text-gray-700 mb-2">Add a comment:</label>
                    <textarea name="content" id="content" rows="4" required 
                              class="w-full" placeholder="Type your comment here..."></textarea>
                </div>
                
                {% if user.role in ['agent', 'admin'] %}
                    <div class="mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" name="is_internal" value="true" class="mr-2">
                            <span class="text-sm">Internal note (not visible to ticket owner)</span>
                        </label>
                    </div>
                {% endif %}
                
                <button type="submit" class="btn btn-primary">Add Comment</button>
            </form>
            
            <!-- Comments List -->
            {% if comments %}
                <div class="space-y-4">
                    {% for comment in comments %}
                        <div class="border-l-4 border-blue-200 pl-4 py-2">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium">{{ comment.author.username }}</span>
                                    {% if comment.is_internal %}
                                        <span class="badge badge-warning">Internal</span>
                                    {% endif %}
                                </div>
                                <span class="text-sm text-gray-500">
                                    {{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}
                                </span>
                            </div>
                            <div class="text-gray-700">
                                {{ comment.content | replace('\n', '<br>') | safe }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500 text-center py-8">No comments yet. Be the first to comment!</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Back Button -->
    <div class="mt-6">
        <a href="{{ url_for('tickets.list_tickets') }}" class="btn btn-outline">
            ← Back to Tickets
        </a>
    </div>
</div>
{% endblock %}
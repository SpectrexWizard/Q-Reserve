{% extends "base.html" %}

{% block title %}Tickets - Helpdesk System{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-900">
        {% if user.role == 'end_user' %}
            My Tickets
        {% else %}
            All Tickets
        {% endif %}
    </h1>
    <a href="{{ url_for('tickets.create_ticket') }}" class="btn btn-primary">
        Create New Ticket
    </a>
</div>

<!-- Filters and Search -->
<div class="card mb-6">
    <div class="card-body">
        <form method="GET" id="search-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
                <label for="search" class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                <input type="text" id="search" name="search" value="{{ current_filters.search }}"
                       class="w-full" placeholder="Search tickets...">
            </div>
            
            <div>
                <label for="status" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select id="status" name="status" class="w-full">
                    <option value="">All Statuses</option>
                    <option value="open" {% if current_filters.status == 'open' %}selected{% endif %}>Open</option>
                    <option value="in_progress" {% if current_filters.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                    <option value="resolved" {% if current_filters.status == 'resolved' %}selected{% endif %}>Resolved</option>
                    <option value="closed" {% if current_filters.status == 'closed' %}selected{% endif %}>Closed</option>
                </select>
            </div>
            
            <div>
                <label for="category_id" class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                <select id="category_id" name="category_id" class="w-full">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if current_filters.category_id == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="sort_by" class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                <select id="sort_by" name="sort_by" class="w-full">
                    <option value="updated_at" {% if current_filters.sort_by == 'updated_at' %}selected{% endif %}>Last Updated</option>
                    <option value="created_at" {% if current_filters.sort_by == 'created_at' %}selected{% endif %}>Created Date</option>
                    <option value="status" {% if current_filters.sort_by == 'status' %}selected{% endif %}>Status</option>
                    <option value="priority" {% if current_filters.sort_by == 'priority' %}selected{% endif %}>Priority</option>
                </select>
                <input type="hidden" name="sort_order" value="{{ current_filters.sort_order }}">
            </div>
            
            <div class="flex items-end gap-2">
                <button type="submit" class="btn btn-primary">Filter</button>
                <a href="{{ url_for('tickets.list_tickets') }}" class="btn btn-outline">Clear</a>
            </div>
        </form>
    </div>
</div>

<!-- Tickets List -->
{% if tickets %}
    <div class="space-y-4">
        {% for ticket in tickets %}
            <div class="card">
                <div class="card-body">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-semibold">
                                    <a href="{{ url_for('tickets.view_ticket', ticket_id=ticket.id) }}" 
                                       class="text-blue-600 hover:underline">
                                        #{{ ticket.id }} - {{ ticket.subject }}
                                    </a>
                                </h3>
                                
                                <span class="badge badge-{{ 'success' if ticket.status == 'open' else 'warning' if ticket.status == 'in_progress' else 'info' if ticket.status == 'resolved' else 'error' }}">
                                    {{ ticket.status.replace('_', ' ').title() }}
                                </span>
                                
                                <span class="badge priority-{{ ticket.priority }}">
                                    {{ ticket.priority.title() }}
                                </span>
                            </div>
                            
                            <p class="text-gray-600 mb-3">{{ ticket.description[:200] }}{% if ticket.description|length > 200 %}...{% endif %}</p>
                            
                            <div class="flex items-center gap-4 text-sm text-gray-500">
                                <span>Category: {{ ticket.category.name }}</span>
                                <span>By: {{ ticket.owner.username }}</span>
                                {% if ticket.assignee %}
                                    <span>Assigned to: {{ ticket.assignee.username }}</span>
                                {% endif %}
                                <span>Created: {{ ticket.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                <span>Updated: {{ ticket.updated_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2 ml-4">
                            <!-- Vote Score -->
                            <div class="text-center">
                                <div class="text-lg font-semibold" id="vote-score-{{ ticket.id }}">
                                    {{ ticket.vote_score }}
                                </div>
                                <div class="text-xs text-gray-500">votes</div>
                            </div>
                            
                            <!-- Vote Buttons -->
                            <div class="flex flex-col gap-1">
                                <button class="btn btn-outline btn-sm vote-btn" 
                                        data-ticket-id="{{ ticket.id }}" 
                                        data-is-upvote="true">
                                    ↑
                                </button>
                                <button class="btn btn-outline btn-sm vote-btn" 
                                        data-ticket-id="{{ ticket.id }}" 
                                        data-is-upvote="false">
                                    ↓
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if pagination.pages > 1 %}
        <div class="flex justify-center mt-8">
            <div class="flex gap-2">
                {% if pagination.has_prev %}
                    <a href="{{ url_for('tickets.list_tickets', page=pagination.prev_num, **current_filters) }}" 
                       class="btn btn-outline">Previous</a>
                {% endif %}
                
                {% for page_num in pagination.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != pagination.page %}
                            <a href="{{ url_for('tickets.list_tickets', page=page_num, **current_filters) }}" 
                               class="btn btn-outline">{{ page_num }}</a>
                        {% else %}
                            <span class="btn btn-primary">{{ page_num }}</span>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                
                {% if pagination.has_next %}
                    <a href="{{ url_for('tickets.list_tickets', page=pagination.next_num, **current_filters) }}" 
                       class="btn btn-outline">Next</a>
                {% endif %}
            </div>
        </div>
    {% endif %}
{% else %}
    <div class="card">
        <div class="card-body text-center py-12">
            <h3 class="text-xl font-medium text-gray-900 mb-2">No tickets found</h3>
            <p class="text-gray-600 mb-4">
                {% if current_filters.search or current_filters.status or current_filters.category_id %}
                    Try adjusting your filters or 
                    <a href="{{ url_for('tickets.list_tickets') }}" class="text-blue-600 hover:underline">view all tickets</a>
                {% else %}
                    Get started by creating your first ticket.
                {% endif %}
            </p>
            <a href="{{ url_for('tickets.create_ticket') }}" class="btn btn-primary">
                Create Your First Ticket
            </a>
        </div>
    </div>
{% endif %}
{% endblock %}